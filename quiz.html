<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dagelijkse Quiz - BlueBadge Training</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="stylesheet" href="style.css?v=1.0.1" />
</head>
<body class="with-sidebar with-right">
  <header>
    <nav class="top-nav">
      <div class="nav-brand">
        <h1><a href="index.html">üöî BlueBadge</a></h1>
      </div>
      <div class="nav-links">
        <a href="index.html" data-i18n="dashboard">Dashboard</a>
        <a href="quiz.html" data-i18n="daily_quiz">Dagelijkse Quiz</a>
        <a href="cognitief.html" data-i18n="cognitive_skills">Cognitieve Vaardigheden</a>
        <a href="taal.html" data-i18n="language_training">Taaltraining</a>
        <a href="voortgang.html" data-i18n="progress">Voortgang</a>
        <a href="scenarios.html" data-i18n="police_scenarios">Politie Scenario's</a>
        <a href="gesprek.html" data-i18n="interview_training">Gesprekstraining</a>
      </div>
      <div class="nav-right">
        <div id="language-switcher"></div>
        <div class="login-section">
          <input id="bb-username" placeholder="Gebruikersnaam" class="username-input" />
          <button class="login-btn" onclick="handleLogin()">Inloggen</button>
        </div>
      </div>
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </nav>
  </header>

  <div class="quiz-header">
    <h1 data-i18n="daily_quiz">Dagelijkse Quiz</h1>
    <p data-i18n="answer_5_questions">Beantwoord de 5 vragen hieronder</p>
  </div>

  <main class="quiz-container" id="quiz-container"></main>
  
  <div class="quiz-controls">
    <button id="end-quiz-btn" class="control-btn primary" style="display:none;" onclick="endQuizEarly()">
      <span data-i18n="finish_quiz">Einde</span>
    </button>
  </div>

  <footer>
    <p data-i18n="copyright">¬© 2025 BlueBadge | Classified Training System</p>
    <p class="footer-note" data-i18n="stay_sharp">Stay sharp. Stay ready. üîç</p>
  </footer>

  <script src="i18n.js?v=1.0.1"></script>
  <script src="auth.js?v=1.0.1"></script>
  <script src="app.js?v=1.0.1"></script>
  <script src="layout.js?v=1.0.1"></script>
  <script>
    const quizContainer = document.getElementById('quiz-container');
    let vragen = [];
    let gekozen = [];
    let currentIndex = 0;
    let score = 0;

    function fisherYatesShuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    async function loadQuiz() {
      try {
        bbLoading.show();
        vragen = await fetchJSON('data/quiz_questions.json', { validate: d => Array.isArray(d) });
      } catch (e) {
        vragen = [];
      }
      if (!Array.isArray(vragen) || vragen.length === 0) {
        vragen = [];
      }
      gekozen = fisherYatesShuffle(vragen).slice(0, 5);
      currentIndex = 0;
      score = 0;
      render(currentIndex);
      bbLoading.hide();
    }

    function render(index) {
      const q = gekozen[index];
      if (!q) return;
      const vraag = sanitizeText(String(q.vraag||''));
      const opts = Array.isArray(q.opties)? q.opties.map(o=> sanitizeText(String(o))): [];
      quizContainer.innerHTML = `
        <div class="question-box">
          <div class="question">${index + 1}. ${vraag}</div>
          <div class="options" role="group" aria-label="Antwoordopties">
            ${opts.map((opt, i) => `<button aria-pressed="false" onclick="beoordeel(this, ${i === q.antwoord})">${opt}</button>`).join('')}
          </div>
        </div>`;
      // Hide Einde by default; it will appear only after last question is answered
      document.getElementById('end-quiz-btn').style.display = 'none';
    }

    window.beoordeel = function (btn, juist) {
      const knoppen = btn.parentNode.querySelectorAll('button');
      knoppen.forEach(b => b.disabled = true);
      if (juist) { btn.classList.add('correct'); score++; } else { btn.classList.add('wrong'); }
      setTimeout(() => {
        const isLast = currentIndex === gekozen.length - 1;
        if (isLast) {
          // Show Einde only after last question is answered
          document.getElementById('end-quiz-btn').style.display = 'inline-block';
          document.getElementById('end-quiz-btn').focus();
        } else {
          currentIndex++;
          render(currentIndex);
        }
      }, 400);
    };

    window.endQuizEarly = function() {
      const answered = Math.min(currentIndex + 1, gekozen.length);
      const percentage = answered > 0 ? Math.round((score / answered) * 100) : 0;
      const payload = { type: 'daily-quiz', score, total: answered, percentage, questions: gekozen.slice(0, answered).map(q=>({ vraag: String(q.vraag||''), opties: Array.isArray(q.opties)? q.opties.map(String): [], correctIndex: q.antwoord })) };
      localStorage.setItem('lastQuizResult', JSON.stringify(payload));
      location.href = 'resultaten.html';
    };

    document.addEventListener('DOMContentLoaded', loadQuiz);
  </script>
</body>
</html>
